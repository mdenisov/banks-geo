// Generated by CoffeeScript 1.6.3
/*
@author: Maxim Denisov (denisovmax1988@yandex.ru)
@date: 19/10/2013
@version: 0.1.1
@copyright: Banki.ru (www.banki.ru)
*/(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},n=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};e=function(){function e(e,n){this.init=t(this.init,this);this._messages={empty_map:"Error: Empty map",empty_options:"Error: Empty map options",empty_center:"Error: Empty center",empty_zoom:"Error: Empty zoom",bad_data:"Error: Bad data object",bad_response:"Error: Bad data object"};this._region=null;this._serviceUrl="/api/";this._ajaxCount=0;this._center=[];this._zoom=10;this._regionIds=["4","211"];this._useMapControl=!0;if(e==null&&typeof e!="string")return this.log(this._messages.empty_map);if(n==null&&typeof e!="object")return this.log(this._messages.empty_options);if(n.region!=null&&parseInt(n.region,10)>0)this._region=n.region;else{if(n.center==null)return this.log(this._messages.empty_center);if(n.zoom==null)return this.log(this._messages.empty_zoom)}n.mapControls!=null&&(this._useMapControl=n.mapControls===!0?!0:!1);this._data=[];this._map;this._container="#"+e;this._$container=$(this._container);this._center=n.center;this._zoom=n.zoom;this._$container.addClass("banks-geo").append('<div class="banks-geo__loader"/>');this._loader=this._$container.children(".banks-geo__loader");n.data!=null&&typeof n.data=="object"&&(this._data=n.data);this.init()}e.prototype.init=function(){return this._region!=null?this.getCenterByRegion():this.initMap()};e.prototype._getAjaxCount=function(){this._ajaxCount++;return this._ajaxCount.toString()};e.prototype._sendAjax=function(e,t){var n=this;e=e||{};return $.ajax(this._serviceUrl,{cache:!1,type:"POST",dataType:"json",data:JSON.stringify({jsonrpc:"2.0",method:e.method,params:e.params,id:this._getAjaxCount()}),error:function(e,t,r){return n.log("AJAX Error: "+t)},success:function(e,r,i){return t!=null?t.call(n,e.result):void 0}})};e.prototype._isUseClusters=function(){var e;return this._region!=null&&(e=this._region,n.call(this._regionIds,e)>=0)?!0:!1};e.prototype.getCenterByRegion=function(){var e;e={method:"region/get",params:{id:this._region}};return this._sendAjax(e,this.processMapOptions)};e.prototype.processMapOptions=function(e){var t;if(e.data!=null){t=e.data;this._center=[parseFloat(t.latitude,10),parseFloat(t.longitude,10)];this._zoom=parseInt(t.zoom,10);return this.initMap()}return this.log(this._messages.bad_response)};e.prototype.initMap=function(){var e=this;return ymaps.ready(function(){e._map=new ymaps.Map(e._$container[0],{_center:e._center,_zoom:e._zoom});e._useMapControl===!0&&e._map.controls.add("zoomControl",{left:5,top:5});e.buildGeoCollection();return e._data!=null&&e._data.length>0?e.processData({data:e._data}):e.getPointsData()})};e.prototype.setData=function(e){return e==null||typeof e!="object"||e.length===0?this.log(this._messages.bad_data):this._data=e};e.prototype.getPointsData=function(){var e,t;e=this.map.getBounds();t={method:"bankGeo/getObjectsByFilter",params:{fields:["bank_id","latitude","longitude","type","is_main","icon_url"],region_id:[this._region],type:["office","branch","atm"],longitude_nw:e[0][1],latitude_nw:e[1][0],longitude_se:e[1][1],latitude_se:e[0][0],zoom:this._zoom}};if(this._isUseClusters()){t.method="bankGeo/getClusters";t.params.region_id=this._region;delete t.params.fields}return this._sendAjax(t,this.processData)};e.prototype.buildGeoCollection=function(){this._isUseClusters()===!0?this._collection=new ymaps.GeoObjectCollection:this._collection=new ymaps.Clusterer({gridSize:128,preset:"twirl#blackClusterIcons",margin:25,minClusterSize:2,clusterDisableClickZoom:!1,balloonShadow:!1});return this.addToMap(this._collection)};e.prototype.processData=function(e){if(e.data!=null&&e.data.length>0){this._data=e.data;this._data.length>500?this.processBigData():this.appendItemsToCollection(this._data)}return this.setLoader(!1)};e.prototype.processBigData=function(){var e,t=this;e=this._data.concat();return setTimeout(function(){var n;n=e.splice(0,1e3);t.appendItemsToCollection(n);if(e.length>0)return setTimeout(arguments.callee,25)},25)};e.prototype.buildGeoObject=function(e){var t,n;if(e.points_count!=null&&e.points_count>1){n="s";t=ymaps.templateLayoutFactory.createClass('<div class="banks-geo__cluster banks-geo__cluster--$[properties.size]" data-type="$[properties.points]">$[properties.points]</div>',{build:function(){return t.superclass.build.call(this)},clear:function(){return t.superclass.clear.call(this)}});e.points_count>=1e3?n="b":e.points_count>=10&&(n="m");return new ymaps.Placemark([e.latitude,e.longitude],{size:n,points:e.points_count,iconContent:e.points_count},{iconLayout:t})}t=ymaps.templateLayoutFactory.createClass('<div class="banks-geo__point $[properties.type] $[properties.main]" data-type="$[properties.type]">$[properties.icon_url]</div>',{build:function(){return t.superclass.build.call(this)},clear:function(){return t.superclass.clear.call(this)}});return new ymaps.Placemark([e.latitude,e.longitude],{id:e.id,type:"banks-geo__point--"+e.type,main:e.is_main===!0?"banks-geo__point--main":"",icon_url:e.icon_url!=null?'<img src="'+e.icon_url+'">':"",hintContent:e.name,balloonContent:e.address},{hasHint:!0,iconLayout:t,balloonCloseButton:!0,balloonShadow:!1})};e.prototype.appendItemsToCollection=function(e){var t,n,r;n=e.length%8;t=e.length-1;while(n>0){this.appendToCollection(this.buildGeoObject(e[t--]));n--}n=Math.floor(e.length/8);r=[];while(n>0){this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));r.push(n--)}return r};e.prototype.appendToCollection=function(e){return this._collection.add(e)};e.prototype.setLoader=function(e){return e!=null&&e===!0?this._loader.show():this._loader.hide()};e.prototype.addToMap=function(e){return this._map.geoObjects.add(e)};e.prototype.setCenter=function(e,t){return this._map.setCenter(e,t)};e.prototype.setZoom=function(e){return this._map.setCenter(e)};e.prototype.log=function(e){return console.log(e)};return e}()}).call(this);