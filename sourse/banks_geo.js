// Generated by CoffeeScript 1.6.3
/*
@author: Maxim Denisov (denisovmax1988@yandex.ru)
@date: 19/10/2013
@version: 0.1.1
@copyright: Banki.ru (www.banki.ru)
*/(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}};e=function(){function e(e,n){this.init=t(this.init,this);this._messages={empty_map:"Error: Empty map",empty_center:"Error: Empty center",empty_zoom:"Error: Empty zoom"};this.useCluster=!0;this.useMapControl=!0;if(e==null)return this.log(this._messages.empty_map);if(n.center==null)return this.log(this._messages.empty_center);if(n.zoom==null)return this.log(this._messages.empty_zoom);n.useCluster!=null&&(this.useCluster=n.useCluster===!0?!0:!1);n.useMapControl!=null&&(this.useMapControl=n.useMapControl===!0?!0:!1);if(e){this.container="#"+e;this.$container=$(this.container);this.center=n.center;this.zoom=n.zoom}if(n.data!=null){typeof n.data=="function"&&this.log("1");typeof n.data=="object"&&(this.data=n.data)}n.url!=null&&typeof n.url=="string"&&(this.url=n.url);ymaps.ready(this.init)}e.prototype.init=function(){this.log("Initialize");this.map=new ymaps.Map(this.$container[0],{center:this.center,zoom:this.zoom});this.useMapControl===!0&&this.map.controls.add("zoomControl",{left:5,top:5});this.buildGeoCollection();this.processData();this.loadData();return this.addToMap(this.collection)};e.prototype.buildGeoCollection=function(){return this.useCluster===!0?this.collection=new ymaps.Clusterer({preset:"twirl#blackClusterIcons"}):this.collection=new ymaps.GeoObjectCollection};e.prototype.loadData=function(){var e=this;if(this.url!=null)return $.ajax(this.url,{dataType:"json",error:function(t,n,r){return e.log("AJAX Error: "+n)},success:function(t,n,r){e.data=t;return e.processData()}})};e.prototype.processData=function(){if(this.data!=null&&this.data.length>0)return this.data.length>500?this.processBigData():this.appendItemsToCollection(this.data)};e.prototype.processBigData=function(){var e,t=this;e=this.data.concat();return setTimeout(function(){var n;n=e.splice(0,1e3);t.appendItemsToCollection(n);if(e.length>0)return setTimeout(arguments.callee,25)},25)};e.prototype.buildGeoObject=function(e){var t;t=ymaps.templateLayoutFactory.createClass('<div class="map__point $[properties.type] $[properties.main]" data-type="$[properties.type]">$[properties.icon_url]</div>',{build:function(){return t.superclass.build.call(this)},clear:function(){return t.superclass.clear.call(this)}});return new ymaps.Placemark([e.latitude,e.longitude],{id:e.id,type:"map__point--"+e.type,main:e.is_main===!0?"map__point--main":"",icon_url:e.icon_url!=null?'<img src="//banki.ru'+e.icon_url+'">':"",hintContent:""},{hasHint:!0,iconLayout:t,balloonShadow:!1})};e.prototype.appendItemsToCollection=function(e){var t,n,r;n=e.length%8;t=e.length-1;while(n){this.appendToCollection(this.buildGeoObject(e[t--]));n--}n=Math.floor(e.length/8);r=[];while(n){this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));this.appendToCollection(this.buildGeoObject(e[t--]));r.push(n--)}return r};e.prototype.appendToCollection=function(e){return this.collection.add(e)};e.prototype.addToMap=function(e){return this.map.geoObjects.add(e)};e.prototype.log=function(e){return console.log(e)};return e}()}).call(this);